<!DOCTYPE html>
<html>
<head>
  <title>Approve Payments</title>
</head>
<body>
<link rel="stylesheet" href="../css/style.css">
<h2>Pending Payments</h2>

<div id="list"></div>

<script type="module">
import { auth, db } from "../js/firebase.js";
import { onAuthStateChanged } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  collection, query, where, getDocs,
  doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const list = document.getElementById("list");

onAuthStateChanged(auth, async (user) => {
  if (!user) return location.href = "admin-login.html";

  const q = query(
    collection(db, "payments"),
    where("status", "==", "pending")
  );

  const snap = await getDocs(q);

  snap.forEach(docSnap => {
    const data = docSnap.data();

    const div = document.createElement("div");
    div.innerHTML = `
      <p>User ID: ${data.userId}</p>
      <a href="${data.screenshotUrl}" target="_blank">View Screenshot</a><br><br>
      <button id="a_${docSnap.id}">Approve</button>
      <button id="r_${docSnap.id}">Reject</button>
      <hr>
    `;
    list.appendChild(div);

    document.getElementById(`a_${docSnap.id}`).onclick = async () => {
      await updateDoc(doc(db, "payments", docSnap.id), {
        status: "approved"
      });
      await updateDoc(doc(db, "users", data.userId), {
        approved: true
      });
      alert("Approved");
      location.reload();
    };

    document.getElementById(`r_${docSnap.id}`).onclick = async () => {
      await updateDoc(doc(db, "payments", docSnap.id), {
        status: "rejected"
      });
      alert("Rejected");
      location.reload();
    };
  });
});
</script>

</body>
</html>
